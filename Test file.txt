@echo off
rem ==========================================================
rem Send_MSG_From_Zip_UI_Audit.bat
rem Author: Vikee (GPT-5)
rem Description:
rem - Browse for ZIP file containing .msg
rem - Extract â†’ Send via Outlook
rem - Progress bar + Dual Logs (TXT, CSV)
rem - Archive processed files
rem - Email final summary with logs attached
rem ==========================================================

echo ----------------------------------------------------------
echo OUTLOOK MSG AUTO-SENDER (ZIP MODE) - AUDIT ENABLED
echo ----------------------------------------------------------
echo.

rem === Step 1: Pick ZIP file ===
powershell -NoProfile -ExecutionPolicy Bypass -Command ^
"Add-Type -AssemblyName System.Windows.Forms;" ^
"$f = New-Object System.Windows.Forms.OpenFileDialog;" ^
"$f.Filter = 'ZIP files (*.zip)|*.zip'; $f.Title = 'Select ZIP file containing .msg files';" ^
"if ($f.ShowDialog() -eq 'OK') { Write-Host $f.FileName }" ^
"> '%temp%\zipfile.txt'"

set /p "ZIPFILE="<"%temp%\zipfile.txt"
del "%temp%\zipfile.txt" >nul 2>&1

if "%ZIPFILE%"=="" (
echo [INFO] No file selected. Exiting.
pause
exit /b
)

if not exist "%ZIPFILE%" (
echo [ERROR] File not found: %ZIPFILE%
pause
exit /b
)

echo Selected ZIP: %ZIPFILE%
echo.

rem === Step 2: Extract ===
set "TEMPFOLDER=%temp%\MSG_Send_%RANDOM%"
mkdir "%TEMPFOLDER%" >nul 2>&1
echo Extracting...
powershell -NoProfile -ExecutionPolicy Bypass -Command ^
"Expand-Archive -Path '%ZIPFILE%' -DestinationPath '%TEMPFOLDER%' -Force"
if errorlevel 1 (
echo [ERROR] Failed to extract ZIP.
pause
exit /b
)

rem === Step 3: Mode selection ===
echo.
echo Choose Mode:
echo [1] Auto Send
echo [2] Open for Review
set /p "MODE=Enter your choice (1 or 2): "
if "%MODE%"=="" set MODE=1

rem === Step 4: Log setup ===
set "ARCHIVE=%TEMPFOLDER%\SentArchive"
mkdir "%ARCHIVE%" >nul 2>&1

for /f "tokens=1-4 delims=/ " %%a in ("%date%") do (
set YYYYMMDD=%%d-%%b-%%a
)
set "LOGTXT=%TEMPFOLDER%\SendLog_%random%.txt"
set "LOGCSV=%TEMPFOLDER%\SendLog_%random%.csv"

echo FileName,Status,Timestamp > "%LOGCSV%"
echo ==== MSG SEND LOG ====%date% %time% > "%LOGTXT%"
echo. >> "%LOGTXT%"

rem === Step 5: PowerShell core logic with progress ===
powershell -NoProfile -ExecutionPolicy Bypass -Command ^
"Add-Type -AssemblyName PresentationFramework,PresentationCore,System.Windows.Forms;" ^
"$folder = '%TEMPFOLDER%'; $archive = '%ARCHIVE%';" ^
"$logTxt = '%LOGTXT%'; $logCsv = '%LOGCSV%'; $mode = '%MODE%';" ^
"$files = Get-ChildItem -Path $folder -Filter '*.msg' -Recurse;" ^
"if ($files.Count -eq 0) { [System.Windows.MessageBox]::Show('No .msg found','Error','OK','Error'); exit }" ^
"$total = $files.Count; $sent = 0; $fail = 0;" ^
"$ol = New-Object -ComObject Outlook.Application;" ^
"$win = New-Object System.Windows.Window; $win.Title='Sending...';$win.Width=400;$win.Height=100;" ^
"$pb = New-Object System.Windows.Controls.ProgressBar;$pb.Minimum=0;$pb.Maximum=$total;$pb.Height=20;$pb.Width=350;$pb.Margin='20,20,20,20';" ^
"$txt = New-Object System.Windows.Controls.TextBlock;$txt.TextAlignment='Center';$txt.Margin='0,50,0,0';" ^
"$grid=New-Object System.Windows.Controls.Grid;$grid.Children.Add($pb)|Out-Null;$grid.Children.Add($txt)|Out-Null;$win.Content=$grid;$win.Show();" ^
"foreach ($f in $files) {" ^
" $pb.Value++; $txt.Text='Processing '+$pb.Value+' of '+$total+': '+$f.Name; [System.Windows.Forms.Application]::DoEvents();" ^
" try {" ^
" $msg=$ol.Session.OpenSharedItem($f.FullName);" ^
" if ($msg -ne $null) {" ^
" if ($mode -eq '1') {$msg.Send();$status='Sent';} else {$msg.Display();$status='Opened';}" ^
" Move-Item $f.FullName -Destination $archive -Force;" ^
" Add-Content $logTxt ('SUCCESS: '+$f.Name);" ^
" Add-Content $logCsv ($f.Name+','+$status+','+(Get-Date)); $sent++;" ^
" } else {Add-Content $logTxt ('FAILED: '+$f.Name);Add-Content $logCsv ($f.Name+',Failed,'+(Get-Date));$fail++;}" ^
" } catch {Add-Content $logTxt ('ERROR: '+$f.Name+' -- '+$_.Exception.Message);Add-Content $logCsv ($f.Name+',Error,'+(Get-Date));$fail++;}" ^
"}" ^
"$win.Close();" ^
"$summary='Total: '+$total+'`nSuccess: '+$sent+'`nFailed: '+$fail+'`nLogs:`n'+$logTxt+'`n'+$logCsv;" ^
"[System.Windows.MessageBox]::Show($summary,'Completed','OK','Information');"

rem === Step 6: Ask for operator email ===
echo.
set /p "USEREMAIL=Enter your email to receive summary (leave blank to skip): "

if not "%USEREMAIL%"=="" (
echo Sending audit summary to %USEREMAIL% ...
powershell -NoProfile -ExecutionPolicy Bypass -Command ^
"$ol = New-Object -ComObject Outlook.Application;" ^
"$mail = $ol.CreateItem(0);" ^
"$mail.To = '%USEREMAIL%';" ^
"$mail.Subject = 'MSG Send Summary - %date%';" ^
"$mail.Body = 'Attached is the send log summary for the latest MSG batch run.';" ^
"if (Test-Path '%LOGCSV%') { $mail.Attachments.Add('%LOGCSV%'); }" ^
"if (Test-Path '%LOGTXT%') { $mail.Attachments.Add('%LOGTXT%'); }" ^
"$mail.Send();"
echo [INFO] Summary email sent successfully.
) else (
echo [INFO] Audit email skipped.
)

rem === Step 7: Ask for cleanup ===
set /p "CLEANUP=Delete extracted temp folder (Y/N)? "
if /I "%CLEANUP%"=="Y" (
rmdir /S /Q "%TEMPFOLDER%"
echo Folder deleted.
) else (
echo Folder retained: %TEMPFOLDER%
)
echo Done.
pause
exit /b


Install-Module -Name ps2exe -Scope CurrentUser
ps2exe "Send_MSG_From_Zip_UI_Enterprise.bat" "Send_MSG_Sender.exe" -icon "mail.ico" -noconsole